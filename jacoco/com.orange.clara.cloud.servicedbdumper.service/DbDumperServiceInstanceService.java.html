<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DbDumperServiceInstanceService.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">db-dumper-service</a> &gt; <a href="index.source.html" class="el_package">com.orange.clara.cloud.servicedbdumper.service</a> &gt; <span class="el_source">DbDumperServiceInstanceService.java</span></div><h1>DbDumperServiceInstanceService.java</h1><pre class="source lang-java linenums">package com.orange.clara.cloud.servicedbdumper.service;

import com.orange.clara.cloud.servicedbdumper.config.Routes;
import com.orange.clara.cloud.servicedbdumper.dbdumper.DatabaseRefManager;
import com.orange.clara.cloud.servicedbdumper.exception.DatabaseExtractionException;
import com.orange.clara.cloud.servicedbdumper.exception.RestoreCannotFindFileException;
import com.orange.clara.cloud.servicedbdumper.exception.RestoreException;
import com.orange.clara.cloud.servicedbdumper.exception.ServiceKeyException;
import com.orange.clara.cloud.servicedbdumper.model.*;
import com.orange.clara.cloud.servicedbdumper.repo.DbDumperPlanRepo;
import com.orange.clara.cloud.servicedbdumper.repo.DbDumperServiceInstanceBindingRepo;
import com.orange.clara.cloud.servicedbdumper.repo.DbDumperServiceInstanceRepo;
import com.orange.clara.cloud.servicedbdumper.repo.JobRepo;
import com.orange.clara.cloud.servicedbdumper.task.job.JobFactory;
import org.cloudfoundry.community.servicebroker.exception.ServiceBrokerException;
import org.cloudfoundry.community.servicebroker.exception.ServiceInstanceDoesNotExistException;
import org.cloudfoundry.community.servicebroker.exception.ServiceInstanceExistsException;
import org.cloudfoundry.community.servicebroker.exception.ServiceInstanceUpdateNotSupportedException;
import org.cloudfoundry.community.servicebroker.model.*;
import org.cloudfoundry.community.servicebroker.service.ServiceInstanceService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.text.ParseException;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.List;
import java.util.Map;

import static com.orange.clara.cloud.servicedbdumper.helper.ParameterParser.getParameter;
import static com.orange.clara.cloud.servicedbdumper.helper.ParameterParser.getParameterAsString;

/**
 * Copyright (C) 2015 Orange
 * &lt;p&gt;
 * This software is distributed under the terms and conditions of the 'Apache-2.0'
 * license which can be found in the file 'LICENSE' in this package distribution
 * or at 'https://opensource.org/licenses/Apache-2.0'.
 * &lt;p&gt;
 * Author: Arthur Halet
 * Date: 12/10/2015
 */
@Service
<span class="fc" id="L48">public class DbDumperServiceInstanceService implements ServiceInstanceService {</span>

    public final static String NEW_SRC_URL_PARAMETER = &quot;db&quot;;
    public final static String SRC_URL_PARAMETER = &quot;src_url&quot;;
    public final static String ACTION_PARAMETER = &quot;action&quot;;
    public final static String CREATED_AT_PARAMETER = &quot;created_at&quot;;
    public final static String NEW_TARGET_URL_PARAMETER = &quot;db&quot;;
    public final static String TARGET_URL_PARAMETER = &quot;target_url&quot;;
    public final static String CF_USER_TOKEN_PARAMETER = &quot;cf_user_token&quot;;
    public final static String ORG_PARAMETER = &quot;org&quot;;
    public final static String SPACE_PARAMETER = &quot;space&quot;;
    public final static String METADATA_PARAMETER = &quot;metadata&quot;;
    public final static String TAGS_SUB_PARAMETER = &quot;tags&quot;;


    private final static String DASHBOARD_ROUTE = Routes.MANAGE_ROOT + Routes.MANAGE_LIST + &quot;/&quot;;
<span class="fc" id="L64">    private final static String[] VALID_DATES_FORMAT = {</span>
            &quot;dd-MM-yyyy HH:mm:ss&quot;,
            &quot;dd/MM/yyyy HH:mm:ss&quot;,
            &quot;yyyy/MM/dd HH:mm:ss&quot;,
            &quot;dd-MM-yyyy HH:mm&quot;,
            &quot;dd/MM/yyyy HH:mm&quot;,
            &quot;yyyy/MM/dd HH:mm&quot;,
            &quot;dd-MM-yyyy HH&quot;,
            &quot;dd/MM/yyyy HH&quot;,
            &quot;yyyy/MM/dd HH&quot;,
            &quot;dd-MM-yyyy&quot;,
            &quot;dd/MM/yyyy&quot;,
            &quot;yyyy/MM/dd&quot;,
            &quot;MM/yyyy&quot;,
            &quot;MM-yyyy&quot;,
            &quot;yyyy/MM&quot;
    };
    @Autowired
    @Qualifier(&quot;appUri&quot;)
    protected String appUri;

<span class="fc" id="L85">    private Logger logger = LoggerFactory.getLogger(DbDumperServiceInstanceService.class);</span>

    @Autowired
    private DatabaseRefManager databaseRefManager;

    @Autowired
    private DbDumperServiceInstanceRepo repository;

    @Autowired
    private DbDumperServiceInstanceBindingRepo serviceInstanceBindingRepo;

    @Autowired
    @Qualifier(&quot;jobFactory&quot;)
    private JobFactory jobFactory;

    @Autowired
    private JobRepo jobRepo;

    @Autowired
    private DbDumperPlanRepo dbDumperPlanRepo;

    @Override
    public ServiceInstance createServiceInstance(CreateServiceInstanceRequest request) throws ServiceInstanceExistsException, ServiceBrokerException {
<span class="fc" id="L108">        DbDumperServiceInstance dbDumperServiceInstance = repository.findOne(request.getServiceInstanceId());</span>
<span class="fc bfc" id="L109" title="All 4 branches covered.">        if (dbDumperServiceInstance != null &amp;&amp; !dbDumperServiceInstance.isDeleted()) {</span>
<span class="fc" id="L110">            throw new ServiceInstanceExistsException(new ServiceInstance(request));</span>
        }
<span class="fc" id="L112">        DbDumperPlan dbDumperPlan = dbDumperPlanRepo.findOne(request.getPlanId());</span>
<span class="fc bfc" id="L113" title="All 2 branches covered.">        if (dbDumperPlan == null) {</span>
<span class="fc" id="L114">            throw new ServiceBrokerException(&quot;Plan '&quot; + request.getPlanId() + &quot;' is not available.&quot;);</span>
        }
<span class="pc bpc" id="L116" title="1 of 4 branches missed.">        if (dbDumperServiceInstance != null &amp;&amp; dbDumperServiceInstance.isDeleted()) {</span>
<span class="fc" id="L117">            dbDumperServiceInstance.setDeleted(false);</span>
        }
<span class="fc bfc" id="L119" title="All 2 branches covered.">        if (dbDumperServiceInstance == null) {</span>
<span class="fc" id="L120">            dbDumperServiceInstance = new DbDumperServiceInstance(</span>
<span class="fc" id="L121">                    request.getServiceInstanceId(),</span>
<span class="fc" id="L122">                    request.getPlanId(),</span>
<span class="fc" id="L123">                    request.getOrganizationGuid(),</span>
<span class="fc" id="L124">                    request.getSpaceGuid(),</span>
                    appUri + DASHBOARD_ROUTE,
                    dbDumperPlan);
        }

<span class="fc" id="L129">        this.createDump(request.getParameters(), dbDumperServiceInstance);</span>
<span class="fc" id="L130">        return new ServiceInstance(request).withDashboardUrl(appUri + DASHBOARD_ROUTE + dbDumperServiceInstance.getServiceInstanceId()).withAsync(true);</span>
    }

    @Override
    public ServiceInstance getServiceInstance(String serviceInstanceId) {
<span class="fc" id="L135">        DbDumperServiceInstance instance = repository.findOne(serviceInstanceId);</span>
<span class="pc bpc" id="L136" title="1 of 4 branches missed.">        if (instance == null || instance.isDeleted()) {</span>
<span class="fc" id="L137">            return null;</span>
        }
<span class="fc" id="L139">        ServiceInstanceLastOperation serviceInstanceLastOperation = null;</span>

<span class="fc" id="L141">        Job lastJob = this.jobRepo.findFirstByDbDumperServiceInstanceOrderByUpdatedAtDesc(instance);</span>
<span class="fc" id="L142">        ServiceInstance serviceInstance = new ServiceInstance(new CreateServiceInstanceRequest().withServiceInstanceId(serviceInstanceId))</span>
<span class="fc" id="L143">                .withDashboardUrl(appUri + DASHBOARD_ROUTE + instance.getDatabaseRef().getName());</span>
<span class="fc bfc" id="L144" title="All 2 branches covered.">        if (lastJob == null) {</span>
<span class="fc" id="L145">            return serviceInstance;</span>
        }
<span class="pc bfc" id="L147" title="All 3 branches covered.">        switch (lastJob.getJobEvent()) {</span>
            case ERRORED:
<span class="fc" id="L149">                serviceInstanceLastOperation = new ServiceInstanceLastOperation(&quot;Error: &quot; + lastJob.getErrorMessage(), OperationState.FAILED);</span>
<span class="fc" id="L150">                break;</span>
            case START:
            case SCHEDULED:
            case RUNNING:
<span class="fc" id="L154">                String description = String.format(&quot;Job of type '%s' for instance '%s' is '%s'\n&quot;, lastJob.getJobType(), instance.getServiceInstanceId(), lastJob.getJobEvent());</span>
<span class="fc" id="L155">                serviceInstanceLastOperation = new ServiceInstanceLastOperation(description, OperationState.IN_PROGRESS);</span>
<span class="fc" id="L156">                break;</span>
            default:
<span class="fc" id="L158">                serviceInstanceLastOperation = new ServiceInstanceLastOperation(&quot;Finished&quot;, OperationState.SUCCEEDED);</span>
                break;
        }
<span class="fc" id="L161">        return serviceInstance.withAsync(true).withLastOperation(serviceInstanceLastOperation);</span>
    }

    @Override
    @Transactional
    public ServiceInstance deleteServiceInstance(DeleteServiceInstanceRequest request) throws ServiceBrokerException {
<span class="fc" id="L167">        DbDumperServiceInstance dbDumperServiceInstance = repository.findOne(request.getServiceInstanceId());</span>
<span class="pc bpc" id="L168" title="1 of 4 branches missed.">        if (dbDumperServiceInstance == null || dbDumperServiceInstance.isDeleted()) {</span>
<span class="fc" id="L169">            logger.warn(&quot;The service instance '&quot; + request.getServiceInstanceId() + &quot;' doesn't exist. Defaulting to say to cloud controller that instance is deleted.&quot;);</span>
<span class="fc" id="L170">            return new ServiceInstance(request);</span>
        }
<span class="fc" id="L172">        this.jobRepo.deleteByDbDumperServiceInstance(dbDumperServiceInstance);</span>


<span class="fc" id="L175">        this.serviceInstanceBindingRepo.deleteByDbDumperServiceInstance(dbDumperServiceInstance);</span>

<span class="fc" id="L177">        dbDumperServiceInstance.setDeleted(true);</span>
<span class="fc" id="L178">        repository.save(dbDumperServiceInstance);</span>

<span class="fc" id="L180">        this.jobFactory.createJobDeleteDbDumperServiceInstance(dbDumperServiceInstance);</span>
<span class="fc" id="L181">        return new ServiceInstance(request).withDashboardUrl(appUri + DASHBOARD_ROUTE + dbDumperServiceInstance.getServiceInstanceId()).withAsync(false);</span>
    }

    @Override
    public ServiceInstance updateServiceInstance(UpdateServiceInstanceRequest request) throws ServiceInstanceUpdateNotSupportedException, ServiceBrokerException, ServiceInstanceDoesNotExistException {
<span class="fc" id="L186">        DbDumperServiceInstance instance = repository.findOne(request.getServiceInstanceId());</span>
<span class="fc" id="L187">        ServiceInstance serviceInstance = new ServiceInstance(request);</span>
<span class="pc bpc" id="L188" title="1 of 4 branches missed.">        if (instance == null || instance.isDeleted()) {</span>
<span class="fc" id="L189">            throw new ServiceInstanceDoesNotExistException(request.getServiceInstanceId());</span>
        }
<span class="fc" id="L191">        Map&lt;String, Object&gt; parameters = request.getParameters();</span>
<span class="fc" id="L192">        UpdateAction action = null;</span>
        try {
<span class="fc" id="L194">            action = UpdateAction.valueOf(parameters.get(ACTION_PARAMETER).toString().toUpperCase());</span>
<span class="fc" id="L195">        } catch (Exception e) {</span>
<span class="fc" id="L196">            throw new ServiceBrokerException(&quot;Action doesn't exist. you need to set this parameter: &quot; + ACTION_PARAMETER + &quot; valid value are: &quot; + UpdateAction.showValues());</span>
<span class="fc" id="L197">        }</span>
<span class="fc bfc" id="L198" title="All 2 branches covered.">        if (action.equals(UpdateAction.DUMP)) {</span>
<span class="fc" id="L199">            this.createDumpFromdbDumperServiceInstance(parameters, instance);</span>
<span class="pc bpc" id="L200" title="1 of 2 branches missed.">        } else if (action.equals(UpdateAction.RESTORE)) {</span>
            try {
<span class="fc" id="L202">                this.restoreDump(request.getParameters(), instance);</span>
<span class="nc" id="L203">            } catch (RestoreCannotFindFileException e) {</span>
<span class="nc" id="L204">                throw new ServiceBrokerException(e.getMessage());</span>
<span class="nc" id="L205">            } catch (RestoreException e) {</span>
<span class="nc" id="L206">                throw new ServiceBrokerException(&quot;An error occurred during restore: &quot; + e.getMessage(), e);</span>
<span class="fc" id="L207">            }</span>
        }
<span class="fc" id="L209">        serviceInstance.withDashboardUrl(appUri + DASHBOARD_ROUTE + instance.getServiceInstanceId()).withAsync(true);</span>
<span class="fc" id="L210">        return serviceInstance;</span>
    }

    private void createDumpFromdbDumperServiceInstance(Map&lt;String, Object&gt; parameters, DbDumperServiceInstance dbDumperServiceInstance) throws ServiceInstanceDoesNotExistException, ServiceBrokerException {
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        if (dbDumperServiceInstance.getDatabaseRef() == null) {</span>
<span class="nc" id="L215">            throw new ServiceInstanceDoesNotExistException(&quot;There is no database set for this instance&quot;);</span>
        }
        try {
<span class="fc" id="L218">            dbDumperServiceInstance.setDatabaseRef(this.databaseRefManager.updateDatabaseRef(dbDumperServiceInstance.getDatabaseRef()));</span>
<span class="nc" id="L219">        } catch (ServiceKeyException | DatabaseExtractionException e) {</span>
<span class="nc" id="L220">            throw new ServiceBrokerException(&quot;An error occurred during dump: &quot; + e.getMessage(), e);</span>
<span class="fc" id="L221">        }</span>
<span class="fc" id="L222">        this.createJobToCreateDump(parameters, dbDumperServiceInstance);</span>
<span class="fc" id="L223">    }</span>

    private void createDump(Map&lt;String, Object&gt; parameters, DbDumperServiceInstance dbDumperServiceInstance) throws ServiceBrokerException {
<span class="fc" id="L226">        String srcUrl = getParameterAsString(parameters, SRC_URL_PARAMETER, null);</span>
<span class="pc bpc" id="L227" title="1 of 2 branches missed.">        if (srcUrl == null) {</span>
<span class="fc" id="L228">            srcUrl = getParameterAsString(parameters, NEW_SRC_URL_PARAMETER);</span>
        }
<span class="fc" id="L230">        DatabaseRef databaseRef = this.getDatabaseRefFromParams(parameters, srcUrl);</span>
<span class="fc" id="L231">        dbDumperServiceInstance.setDatabaseRef(databaseRef);</span>
<span class="fc" id="L232">        repository.save(dbDumperServiceInstance);</span>
<span class="fc" id="L233">        this.createJobToCreateDump(parameters, dbDumperServiceInstance);</span>
<span class="fc" id="L234">    }</span>

    private void createJobToCreateDump(Map&lt;String, Object&gt; parameters, DbDumperServiceInstance dbDumperServiceInstance) {
<span class="fc" id="L237">        Map&lt;String, Object&gt; metadataParameters = (Map&lt;String, Object&gt;) getParameter(parameters, METADATA_PARAMETER, null, Map.class);</span>
<span class="fc bfc" id="L238" title="All 2 branches covered.">        if (metadataParameters == null) {</span>
<span class="fc" id="L239">            this.jobFactory.createJobCreateDump(dbDumperServiceInstance);</span>
<span class="fc" id="L240">            return;</span>
        }
<span class="fc" id="L242">        List&lt;String&gt; tags = (List&lt;String&gt;) getParameter(metadataParameters, TAGS_SUB_PARAMETER, null, List.class);</span>
<span class="fc" id="L243">        Metadata metadata = new Metadata();</span>
<span class="fc" id="L244">        metadata.setTags(tags);</span>
<span class="fc" id="L245">        this.jobFactory.createJobCreateDump(dbDumperServiceInstance, metadata);</span>
<span class="fc" id="L246">    }</span>

    private DatabaseRef getDatabaseRefFromParams(Map&lt;String, Object&gt; parameters, String dbUrlOrService) throws ServiceBrokerException {
<span class="fc" id="L249">        String token = getParameterAsString(parameters, CF_USER_TOKEN_PARAMETER, null);</span>
<span class="fc" id="L250">        String org = getParameterAsString(parameters, ORG_PARAMETER, null);</span>
<span class="fc" id="L251">        String space = getParameterAsString(parameters, SPACE_PARAMETER, null);</span>
        try {
<span class="fc" id="L253">            return this.databaseRefManager.getDatabaseRef(dbUrlOrService, token, org, space);</span>
<span class="fc" id="L254">        } catch (ServiceKeyException | DatabaseExtractionException e) {</span>
<span class="fc" id="L255">            throw new ServiceBrokerException(&quot;Error when getting database: &quot; + e.getMessage(), e);</span>
        }
    }

    private void restoreDump(Map&lt;String, Object&gt; parameters, DbDumperServiceInstance dbDumperServiceInstance) throws ServiceBrokerException, RestoreException {
<span class="fc" id="L260">        String targetUrl = getParameterAsString(parameters, TARGET_URL_PARAMETER, null);</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        if (targetUrl == null) {</span>
<span class="fc" id="L262">            targetUrl = getParameterAsString(parameters, NEW_TARGET_URL_PARAMETER);</span>
        }
<span class="fc" id="L264">        String createdAtString = getParameterAsString(parameters, CREATED_AT_PARAMETER, null);</span>
<span class="fc" id="L265">        DatabaseRef databaseRefTarget = this.getDatabaseRefFromParams(parameters, targetUrl);</span>
<span class="pc bpc" id="L266" title="3 of 4 branches missed.">        if (createdAtString == null || createdAtString.isEmpty()) {</span>
<span class="fc" id="L267">            this.jobFactory.createJobRestoreDump(databaseRefTarget, null, dbDumperServiceInstance);</span>
<span class="fc" id="L268">            return;</span>
        }
        Date createdAt;
        try {
<span class="nc" id="L272">            createdAt = this.parseDate(createdAtString);</span>
<span class="nc" id="L273">        } catch (ParseException e) {</span>
<span class="nc" id="L274">            throw new ServiceBrokerException(&quot;When use &quot; + CREATED_AT_PARAMETER + &quot; parameter you should pass a date in one of this forms: &quot; + String.join(&quot;, &quot;, VALID_DATES_FORMAT));</span>
<span class="nc" id="L275">        }</span>
<span class="nc" id="L276">        this.jobFactory.createJobRestoreDump(databaseRefTarget, createdAt, dbDumperServiceInstance);</span>
<span class="nc" id="L277">    }</span>


    protected Date parseDate(String date) throws ParseException {
        SimpleDateFormat simpleDateFormat;
<span class="nc" id="L282">        Date createdAt = null;</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">        for (String validDateFormat : VALID_DATES_FORMAT) {</span>
<span class="nc" id="L284">            simpleDateFormat = new SimpleDateFormat(validDateFormat);</span>
            try {
<span class="nc" id="L286">                createdAt = simpleDateFormat.parse(date);</span>
<span class="nc" id="L287">                break;</span>
<span class="nc" id="L288">            } catch (ParseException e) {</span>
<span class="nc" id="L289">                createdAt = null;</span>
            }
        }
<span class="nc bnc" id="L292" title="All 2 branches missed.">        if (createdAt == null) {</span>
<span class="nc" id="L293">            throw new ParseException(&quot;Cannot parse date&quot;, 0);</span>
        }
<span class="nc" id="L295">        return createdAt;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>