<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>DatabaseRefManager.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">db-dumper-service</a> &gt; <a href="index.source.html" class="el_package">com.orange.clara.cloud.servicedbdumper.dbdumper</a> &gt; <span class="el_source">DatabaseRefManager.java</span></div><h1>DatabaseRefManager.java</h1><pre class="source lang-java linenums">package com.orange.clara.cloud.servicedbdumper.dbdumper;

import com.orange.clara.cloud.servicedbdumper.exception.DatabaseExtractionException;
import com.orange.clara.cloud.servicedbdumper.exception.ServiceKeyException;
import com.orange.clara.cloud.servicedbdumper.helper.URICheck;
import com.orange.clara.cloud.servicedbdumper.model.DatabaseRef;
import com.orange.clara.cloud.servicedbdumper.model.DatabaseService;
import com.orange.clara.cloud.servicedbdumper.model.DatabaseType;
import com.orange.clara.cloud.servicedbdumper.model.Job;
import com.orange.clara.cloud.servicedbdumper.repo.DatabaseRefRepo;
import com.orange.clara.cloud.servicedbdumper.repo.DatabaseServiceRepo;
import com.orange.clara.cloud.servicedbdumper.service.servicekey.ServiceKeyManager;
import org.cloudfoundry.client.lib.domain.CloudService;
import org.cloudfoundry.client.lib.domain.CloudServiceKey;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Component;

import java.net.URI;
import java.net.URISyntaxException;
import java.util.Map;
import java.util.UUID;

/**
 * Copyright (C) 2016 Orange
 * &lt;p&gt;
 * This software is distributed under the terms and conditions of the 'Apache-2.0'
 * license which can be found in the file 'LICENSE' in this package distribution
 * or at 'https://opensource.org/licenses/Apache-2.0'.
 * &lt;p&gt;
 * Author: Arthur Halet
 * Date: 18/02/2016
 */
@Component
<span class="fc" id="L36">public class DatabaseRefManager {</span>

    private final static String URI_KEY_REGEX = &quot;(uri|url)&quot;;
    private final static String HOST_KEY_REGEX = &quot;.*host.*&quot;;
    private final static String PASSWORD_KEY_REGEX = &quot;.*pass.*&quot;;
    private final static String USERNAME_KEY_REGEX = &quot;.*user.*&quot;;
    private final static String PORT_KEY_REGEX = &quot;.*port.*&quot;;
    private final static String DATABASE_NAME_KEY_REGEX = &quot;.*name.*&quot;;

<span class="fc" id="L45">    private Logger logger = LoggerFactory.getLogger(DatabaseRefManager.class);</span>

    @Autowired
    private DatabaseRefRepo databaseRefRepo;

    @Autowired
    private DatabaseServiceRepo databaseServiceRepo;

    @Autowired
    private ServiceKeyManager serviceKeyManager;

    public DatabaseRef getDatabaseRef(String uriOrServiceName, String token, String org, String space) throws ServiceKeyException, DatabaseExtractionException {
<span class="fc bfc" id="L57" title="All 2 branches covered.">        if (URICheck.isUri(uriOrServiceName)) {</span>
<span class="fc" id="L58">            return this.getDatabaseRefFromUrl(uriOrServiceName, this.generateDatabaseRefName(uriOrServiceName));</span>
        }
<span class="pc bpc" id="L60" title="1 of 4 branches missed.">        if (token == null || token.isEmpty()) {</span>
<span class="fc" id="L61">            throw new ServiceKeyException(&quot;You must pass your token (param: cf_user_token)&quot;);</span>
        }
<span class="pc bpc" id="L63" title="2 of 8 branches missed.">        if (org == null || org.isEmpty() || space == null || space.isEmpty()) {</span>
<span class="fc" id="L64">            throw new ServiceKeyException(&quot;Space and org parameters can't be empty. (params: space, org)&quot;);</span>
        }
<span class="fc" id="L66">        String sanitizedToken = this.sanitizeToken(token);</span>
<span class="fc" id="L67">        CloudServiceKey cloudServiceKey = this.serviceKeyManager.createServiceKey(uriOrServiceName, sanitizedToken, org, space);</span>
<span class="fc" id="L68">        return this.getDatabaseRefFromServiceKey(cloudServiceKey, org, space);</span>
    }

    public DatabaseRef updateDatabaseRef(DatabaseRef databaseRef) throws ServiceKeyException, DatabaseExtractionException {
<span class="fc bfc" id="L72" title="All 2 branches covered.">        if (databaseRef.getDatabaseService() == null) {</span>
<span class="fc" id="L73">            return databaseRef;</span>
        }
<span class="fc" id="L75">        DatabaseService databaseService = databaseRef.getDatabaseService();</span>
<span class="fc" id="L76">        CloudServiceKey cloudServiceKey = this.serviceKeyManager.createServiceKey(databaseService);</span>
<span class="fc" id="L77">        return this.getDatabaseRefFromServiceKey(cloudServiceKey, databaseService.getOrg(), databaseService.getSpace());</span>
    }

    public void deleteServiceKey(Job job) {
<span class="pc bpc" id="L81" title="1 of 2 branches missed.">        if (job.getDatabaseRefSrc() != null) {</span>
<span class="fc" id="L82">            this.deleteServiceKey(job.getDatabaseRefSrc());</span>
        }
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (job.getDatabaseRefTarget() != null) {</span>
<span class="fc" id="L85">            this.deleteServiceKey(job.getDatabaseRefTarget());</span>
        }
<span class="fc" id="L87">    }</span>

    public void deleteServiceKey(DatabaseRef databaseRef) {
<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (databaseRef.getDatabaseService() == null</span>
<span class="fc bfc" id="L91" title="All 2 branches covered.">                || databaseRef.getDatabaseService().getServiceKeyGuid() == null) {</span>
<span class="fc" id="L92">            return;</span>
        }
<span class="fc" id="L94">        DatabaseService databaseService = databaseRef.getDatabaseService();</span>
<span class="fc" id="L95">        logger.info(String.format(&quot;Removing service key for service '%s' ...&quot;, databaseService.getName()));</span>
<span class="fc" id="L96">        this.serviceKeyManager.deleteServiceKey(databaseService);</span>
<span class="fc" id="L97">        databaseRef.setUser(&quot;&quot;);</span>
<span class="fc" id="L98">        databaseRef.setPassword(&quot;&quot;);</span>
<span class="fc" id="L99">        this.databaseRefRepo.save(databaseRef);</span>
<span class="fc" id="L100">        databaseService.setServiceKeyGuid(null);</span>
<span class="fc" id="L101">        this.databaseServiceRepo.save(databaseService);</span>
<span class="fc" id="L102">        logger.info(String.format(&quot;Removed service key for service '%s'.&quot;, databaseService.getName()));</span>
<span class="fc" id="L103">    }</span>

    protected String sanitizeToken(String token) {
<span class="fc" id="L106">        String sanitizedToken = token.replaceAll(&quot;(?i)^bearer&quot;, &quot;&quot;);</span>
<span class="fc" id="L107">        sanitizedToken = sanitizedToken.trim();</span>
<span class="fc" id="L108">        return sanitizedToken;</span>
    }


    private DatabaseRef getDatabaseRefFromUrl(String dbUrl, String name) throws DatabaseExtractionException {
<span class="fc" id="L113">        DatabaseRef databaseRef = new DatabaseRef(name, URI.create(dbUrl));</span>
<span class="fc" id="L114">        DatabaseRef databaseRefDao = null;</span>
<span class="fc bfc" id="L115" title="All 2 branches covered.">        if (!this.databaseRefRepo.exists(name)) {</span>
<span class="fc" id="L116">            this.databaseRefRepo.save(databaseRef);</span>
<span class="fc" id="L117">            return databaseRef;</span>
        }
<span class="fc" id="L119">        databaseRefDao = this.databaseRefRepo.findOne(name);</span>
<span class="fc" id="L120">        this.updateDatabaseRef(databaseRef, databaseRefDao);</span>

<span class="fc" id="L122">        return databaseRefDao;</span>
    }


    private DatabaseRef getDatabaseRefFromServiceKey(CloudServiceKey cloudServiceKey, String org, String space) throws DatabaseExtractionException {
<span class="fc" id="L127">        String dbUrl = this.extractUriFromCredentialKey(cloudServiceKey.getCredentials());</span>
<span class="fc bfc" id="L128" title="All 2 branches covered.">        if (dbUrl.isEmpty()) {</span>
<span class="fc" id="L129">            dbUrl = this.extractUriFromCloudServiceKey(cloudServiceKey);</span>
        }
<span class="fc" id="L131">        DatabaseRef databaseRef = this.getDatabaseRefFromUrl(dbUrl, cloudServiceKey.getService().getMeta().getGuid().toString());</span>
<span class="fc" id="L132">        DatabaseService databaseService = this.getDatabaseServiceFromServiceKey(cloudServiceKey, databaseRef, org, space);</span>
<span class="fc" id="L133">        databaseRef.setDatabaseService(databaseService);</span>
<span class="fc" id="L134">        this.databaseRefRepo.save(databaseRef);</span>
<span class="fc" id="L135">        return databaseRef;</span>
    }

    private DatabaseService getDatabaseServiceFromServiceKey(CloudServiceKey cloudServiceKey, DatabaseRef databaseRef, String org, String space) {
<span class="fc" id="L139">        CloudService cloudService = cloudServiceKey.getService();</span>
<span class="fc" id="L140">        DatabaseService databaseService = new DatabaseService(</span>
<span class="fc" id="L141">                cloudService.getMeta().getGuid().toString(),</span>
<span class="fc" id="L142">                cloudService.getName(),</span>
                org,
                space,
<span class="fc" id="L145">                cloudServiceKey.getMeta().getGuid().toString()</span>
        );

<span class="fc bfc" id="L148" title="All 2 branches covered.">        if (!this.databaseServiceRepo.exists(cloudService.getMeta().getGuid().toString())) {</span>
<span class="fc" id="L149">            databaseService.setDatabaseRef(databaseRef);</span>
<span class="fc" id="L150">            this.databaseServiceRepo.save(databaseService);</span>
<span class="fc" id="L151">            return databaseService;</span>
        }
<span class="fc" id="L153">        DatabaseService databaseServiceDao = this.databaseServiceRepo.findOne(cloudService.getMeta().getGuid().toString());</span>
<span class="fc" id="L154">        this.updateDatabaseService(databaseService, databaseServiceDao);</span>
<span class="fc" id="L155">        return databaseServiceDao;</span>
    }

    private DatabaseType extractDatabaseType(CloudService cloudService) {
<span class="fc" id="L159">        return this.extractDatabaseType(cloudService.getLabel(), cloudService.getName());</span>
    }

    private DatabaseType extractDatabaseType(String... values) {
        DatabaseType databaseType;
<span class="fc bfc" id="L164" title="All 2 branches covered.">        for (String value : values) {</span>
<span class="fc" id="L165">            databaseType = this.extractDatabaseType(value);</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">            if (databaseType != null) {</span>
<span class="fc" id="L167">                return databaseType;</span>
            }
        }
<span class="fc" id="L170">        return null;</span>
    }

    private DatabaseType extractDatabaseType(String value) {
<span class="pc bpc" id="L174" title="1 of 2 branches missed.">        if (value == null) {</span>
<span class="nc" id="L175">            return null;</span>
        }
<span class="fc bfc" id="L177" title="All 2 branches covered.">        for (DatabaseType databaseType : DatabaseType.values()) {</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">            if (value.matches(databaseType.getMatcher())) {</span>
<span class="fc" id="L179">                return databaseType;</span>
            }
        }
<span class="fc" id="L182">        return null;</span>
    }

    private String extractUriFromCloudServiceKey(CloudServiceKey cloudServiceKey) throws DatabaseExtractionException {
<span class="fc" id="L186">        CloudService cloudService = cloudServiceKey.getService();</span>
<span class="fc" id="L187">        logger.debug(&quot;Service found: &quot; + cloudService.getMeta() + &quot; with label: &quot; + cloudService.getLabel());</span>
<span class="fc" id="L188">        Map&lt;String, Object&gt; credentials = cloudServiceKey.getCredentials();</span>

<span class="fc" id="L190">        DatabaseType databaseType = this.extractDatabaseType(cloudService);</span>
<span class="fc bfc" id="L191" title="All 2 branches covered.">        if (databaseType == null) {</span>
<span class="fc" id="L192">            throw new DatabaseExtractionException(&quot;Database type cannot be extracted '&quot; + cloudService.getName() + &quot;'&quot;);</span>
        }
<span class="fc" id="L194">        String host = this.extractHostFromCredentials(credentials);</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">        if (host.isEmpty()) {</span>
<span class="nc" id="L196">            throw new DatabaseExtractionException(&quot;Hostname cannot be extracted from service '&quot; + cloudService.getName() + &quot;'&quot;);</span>
        }

<span class="fc" id="L199">        String databaseName = &quot;/&quot; + this.extractDatabaseNameFromCredentials(credentials);</span>
<span class="fc" id="L200">        String username = this.extractUsernameFromCredentials(credentials);</span>
<span class="fc" id="L201">        String password = this.extractPasswordFromCredentials(credentials);</span>
<span class="fc" id="L202">        String portString = this.extractPortFromCredentials(credentials);</span>
<span class="fc" id="L203">        int port = databaseType.getDefaultPort();</span>
<span class="pc bpc" id="L204" title="1 of 2 branches missed.">        if (!portString.isEmpty()) {</span>
<span class="nc" id="L205">            port = Integer.parseInt(portString);</span>
        }
<span class="fc" id="L207">        String userInfo = &quot;&quot;;</span>
<span class="pc bpc" id="L208" title="2 of 4 branches missed.">        if (!username.isEmpty() &amp;&amp; !password.isEmpty()) {</span>
<span class="fc" id="L209">            userInfo = username + &quot;:&quot; + password;</span>
        }
<span class="pc bpc" id="L211" title="2 of 4 branches missed.">        if (!password.isEmpty() &amp;&amp; username.isEmpty()) {</span>
<span class="nc" id="L212">            userInfo = password;</span>
        }
        try {
<span class="fc" id="L215">            URI generatedUri = new URI(databaseType.name().toLowerCase(), userInfo, host, port, databaseName, null, null);</span>
<span class="fc" id="L216">            return generatedUri.toString();</span>
<span class="nc" id="L217">        } catch (URISyntaxException e) {</span>
<span class="nc" id="L218">            throw new DatabaseExtractionException(&quot;Database cannot be extracted from service '&quot; + cloudService.getName() + &quot;' - Error: &quot; + e.getMessage(), e);</span>
        }

    }

    private String extractUriFromCredentialKey(Map&lt;String, Object&gt; credentials) {
<span class="fc" id="L224">        return this.extractValueFromCredentials(credentials, URI_KEY_REGEX);</span>
    }

    private String extractHostFromCredentials(Map&lt;String, Object&gt; credentials) {
<span class="fc" id="L228">        return this.extractValueFromCredentials(credentials, HOST_KEY_REGEX);</span>
    }

    private String extractUsernameFromCredentials(Map&lt;String, Object&gt; credentials) {
<span class="fc" id="L232">        return this.extractValueFromCredentials(credentials, USERNAME_KEY_REGEX);</span>
    }

    private String extractPasswordFromCredentials(Map&lt;String, Object&gt; credentials) {
<span class="fc" id="L236">        return this.extractValueFromCredentials(credentials, PASSWORD_KEY_REGEX);</span>
    }

    private String extractPortFromCredentials(Map&lt;String, Object&gt; credentials) {
<span class="fc" id="L240">        return this.extractValueFromCredentials(credentials, PORT_KEY_REGEX);</span>
    }

    private String extractDatabaseNameFromCredentials(Map&lt;String, Object&gt; credentials) {
<span class="fc" id="L244">        return this.extractValueFromCredentials(credentials, DATABASE_NAME_KEY_REGEX);</span>
    }

    private String extractValueFromCredentials(Map&lt;String, Object&gt; credentials, String keyToFind) {
<span class="fc bfc" id="L248" title="All 2 branches covered.">        for (String key : credentials.keySet()) {</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">            if (key.matches(keyToFind)) {</span>
<span class="fc" id="L250">                return credentials.get(key).toString();</span>
            }
<span class="fc" id="L252">        }</span>
<span class="fc" id="L253">        return &quot;&quot;;</span>
    }

    private void updateDatabaseRef(DatabaseRef databaseRefTemp, DatabaseRef databaseRefDao) {
<span class="fc bfc" id="L257" title="All 2 branches covered.">        if (databaseRefDao.getUser().equals(databaseRefTemp.getUser())</span>
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">                &amp;&amp; databaseRefDao.getDatabaseName().equals(databaseRefTemp.getDatabaseName())</span>
<span class="pc bpc" id="L259" title="1 of 2 branches missed.">                &amp;&amp; databaseRefDao.getHost().equals(databaseRefTemp.getHost())</span>
<span class="pc bpc" id="L260" title="1 of 2 branches missed.">                &amp;&amp; databaseRefDao.getPassword().equals(databaseRefTemp.getPassword())</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">                &amp;&amp; databaseRefDao.getPort().equals(databaseRefTemp.getPort())</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">                &amp;&amp; databaseRefDao.getType().equals(databaseRefTemp.getType())</span>
                ) {
<span class="fc" id="L264">            return;</span>
        }
<span class="fc" id="L266">        databaseRefDao.setDatabaseName(databaseRefTemp.getDatabaseName());</span>
<span class="fc" id="L267">        databaseRefDao.setHost(databaseRefTemp.getHost());</span>
<span class="fc" id="L268">        databaseRefDao.setPassword(databaseRefTemp.getPassword());</span>
<span class="fc" id="L269">        databaseRefDao.setPort(databaseRefTemp.getPort());</span>
<span class="fc" id="L270">        databaseRefDao.setType(databaseRefTemp.getType());</span>
<span class="fc" id="L271">        databaseRefDao.setUser(databaseRefTemp.getUser());</span>
<span class="fc" id="L272">        this.databaseRefRepo.save(databaseRefDao);</span>
<span class="fc" id="L273">    }</span>

    private void updateDatabaseService(DatabaseService databaseServiceTemp, DatabaseService databaseServiceDao) {
<span class="fc" id="L276">        databaseServiceDao.setServiceKeyGuid(databaseServiceTemp.getServiceKeyGuid());</span>
<span class="fc" id="L277">        this.databaseServiceRepo.save(databaseServiceDao);</span>
<span class="fc" id="L278">    }</span>

    protected String generateDatabaseRefName(String srcUrl) {
<span class="fc" id="L281">        UUID dbRefName = UUID.nameUUIDFromBytes(srcUrl.getBytes());</span>
<span class="fc" id="L282">        return dbRefName.toString();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>