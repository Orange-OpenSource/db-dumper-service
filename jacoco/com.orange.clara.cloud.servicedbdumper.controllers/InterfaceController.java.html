<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../.resources/report.css" type="text/css"/><link rel="shortcut icon" href="../.resources/report.gif" type="image/gif"/><title>InterfaceController.java</title><link rel="stylesheet" href="../.resources/prettify.css" type="text/css"/><script type="text/javascript" src="../.resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../.sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">db-dumper-service</a> &gt; <a href="index.source.html" class="el_package">com.orange.clara.cloud.servicedbdumper.controllers</a> &gt; <span class="el_source">InterfaceController.java</span></div><h1>InterfaceController.java</h1><pre class="source lang-java linenums">package com.orange.clara.cloud.servicedbdumper.controllers;

import com.google.common.collect.Lists;
import com.orange.clara.cloud.servicedbdumper.config.Routes;
import com.orange.clara.cloud.servicedbdumper.exception.UserAccessRightException;
import com.orange.clara.cloud.servicedbdumper.helper.UrlForge;
import com.orange.clara.cloud.servicedbdumper.model.DatabaseRef;
import com.orange.clara.cloud.servicedbdumper.model.DbDumperServiceInstance;
import com.orange.clara.cloud.servicedbdumper.repo.DatabaseRefRepo;
import com.orange.clara.cloud.servicedbdumper.repo.DbDumperServiceInstanceRepo;
import com.orange.clara.cloud.servicedbdumper.security.useraccess.UserAccessRight;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Qualifier;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;

import java.io.IOException;
import java.util.List;

/**
 * Copyright (C) 2015 Orange
 * &lt;p&gt;
 * This software is distributed under the terms and conditions of the 'Apache-2.0'
 * license which can be found in the file 'LICENSE' in this package distribution
 * or at 'https://opensource.org/licenses/Apache-2.0'.
 * &lt;p&gt;
 * Author: Arthur Halet
 * Date: 15/10/2015
 */
@Controller
@RequestMapping(value = Routes.MANAGE_ROOT)
<span class="fc" id="L34">public class InterfaceController extends AbstractController {</span>

    @Autowired
    private DatabaseRefRepo databaseRefRepo;
    @Autowired
    private UrlForge urlForge;
    @Autowired
    private DbDumperServiceInstanceRepo instanceRepository;

    @Autowired
    @Qualifier(&quot;currency&quot;)
    private String currency;


    @Autowired
    @Qualifier(&quot;isFree&quot;)
    private Boolean isFree;

    @Autowired
    @Qualifier(&quot;userAccessRight&quot;)
    private UserAccessRight userAccessRight;

    @RequestMapping(Routes.MANAGE_LIST)
    public String list(Model model) throws IOException, UserAccessRightException {
<span class="fc" id="L58">        List&lt;DatabaseRef&gt; databaseRefs = Lists.newArrayList(this.databaseRefRepo.findAll());</span>
<span class="fc" id="L59">        model.addAttribute(&quot;databaseRefs&quot;, this.filteringDatabaseRef(databaseRefs));</span>
<span class="fc" id="L60">        model.addAttribute(&quot;urlForge&quot;, urlForge);</span>
<span class="fc" id="L61">        model.addAttribute(&quot;currency&quot;, currency);</span>
<span class="fc" id="L62">        model.addAttribute(&quot;isFree&quot;, isFree);</span>
<span class="fc" id="L63">        this.addDefaultAttribute(model);</span>
<span class="fc" id="L64">        return &quot;listfiles&quot;;</span>
    }

    private List&lt;DatabaseRef&gt; filteringDatabaseRef(List&lt;DatabaseRef&gt; databaseRefs) throws UserAccessRightException {
<span class="fc" id="L68">        List&lt;DatabaseRef&gt; databaseRefsFinal = Lists.newArrayList();</span>
<span class="fc bfc" id="L69" title="All 2 branches covered.">        for (DatabaseRef databaseRef : databaseRefs) {</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">            if (databaseRef.getDbDumperServiceInstances() == null</span>
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">                    || !this.userAccessRight.haveAccessToServiceInstance(databaseRef)</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">                    || databaseRefsFinal.contains(databaseRef)) {</span>
<span class="nc" id="L73">                continue;</span>
            }
<span class="fc" id="L75">            List&lt;DbDumperServiceInstance&gt; serviceInstances = databaseRef.getDbDumperServiceInstances();</span>
<span class="fc" id="L76">            databaseRef.setDbDumperServiceInstances(this.filteringDbDumperServiceInstance(serviceInstances));</span>
<span class="fc bfc" id="L77" title="All 2 branches covered.">            if (databaseRef.getDbDumperServiceInstances().size() == 0) {</span>
<span class="fc" id="L78">                continue;</span>
            }
<span class="fc" id="L80">            databaseRefsFinal.add(databaseRef);</span>
<span class="fc" id="L81">        }</span>
<span class="fc" id="L82">        return databaseRefsFinal;</span>
    }

    private List&lt;DbDumperServiceInstance&gt; filteringDbDumperServiceInstance(List&lt;DbDumperServiceInstance&gt; serviceInstances) throws UserAccessRightException {
<span class="fc" id="L86">        List&lt;DbDumperServiceInstance&gt; serviceInstancesFinal = Lists.newArrayList();</span>
<span class="fc bfc" id="L87" title="All 2 branches covered.">        for (DbDumperServiceInstance serviceInstance : serviceInstances) {</span>
<span class="fc bfc" id="L88" title="All 2 branches covered.">            if (serviceInstance.isDeleted()</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">                    || !this.userAccessRight.haveAccessToServiceInstance(serviceInstance)</span>
<span class="pc bpc" id="L90" title="1 of 2 branches missed.">                    || serviceInstancesFinal.contains(serviceInstance)) {</span>
<span class="nc" id="L91">                continue;</span>
            }
<span class="fc" id="L93">            serviceInstancesFinal.add(serviceInstance);</span>
<span class="fc" id="L94">        }</span>
<span class="fc" id="L95">        return serviceInstancesFinal;</span>
    }

    @RequestMapping(Routes.MANAGE_LIST + &quot;/{instanceId}&quot;)
    public String listFromInstance(@PathVariable String instanceId, Model model) throws IOException, UserAccessRightException {
<span class="fc" id="L100">        DbDumperServiceInstance serviceInstance = instanceRepository.findOne(instanceId);</span>
<span class="pc bpc" id="L101" title="2 of 4 branches missed.">        if (serviceInstance != null &amp;&amp; !this.userAccessRight.haveAccessToServiceInstance(serviceInstance)) {</span>
<span class="nc" id="L102">            throw new UserAccessRightException(&quot;You don't have access to this instance&quot;);</span>
        }
<span class="fc" id="L104">        List&lt;DatabaseRef&gt; databaseRefs = Lists.newArrayList();</span>
<span class="pc bpc" id="L105" title="1 of 2 branches missed.">        if (serviceInstance != null) {</span>
<span class="fc" id="L106">            DatabaseRef databaseRef = serviceInstance.getDatabaseRef();</span>
<span class="fc" id="L107">            databaseRef.setDbDumperServiceInstances(Lists.newArrayList(serviceInstance));</span>
<span class="fc" id="L108">            databaseRefs.add(databaseRef);</span>
        }
<span class="fc" id="L110">        model.addAttribute(&quot;databaseRefs&quot;, databaseRefs);</span>
<span class="fc" id="L111">        model.addAttribute(&quot;urlForge&quot;, urlForge);</span>
<span class="fc" id="L112">        model.addAttribute(&quot;currency&quot;, currency);</span>
<span class="fc" id="L113">        model.addAttribute(&quot;isFree&quot;, isFree);</span>
<span class="fc" id="L114">        this.addDefaultAttribute(model);</span>
<span class="fc" id="L115">        return &quot;listfiles&quot;;</span>
    }

    @RequestMapping(Routes.MANAGE_LIST_DATABASE_ROOT + &quot;/{databaseName}&quot;)
    public String listFromDatabase(@PathVariable String databaseName, Model model) throws IOException, UserAccessRightException {
<span class="fc" id="L120">        DatabaseRef databaseRef = this.databaseRefRepo.findOne(databaseName);</span>
<span class="pc bpc" id="L121" title="1 of 2 branches missed.">        if (databaseRef == null) {</span>
<span class="nc" id="L122">            throw new IllegalArgumentException(String.format(&quot;Cannot find database with name '%s'&quot;, databaseName));</span>
        }
<span class="pc bpc" id="L124" title="1 of 2 branches missed.">        if (!this.userAccessRight.haveAccessToServiceInstance(databaseRef)) {</span>
<span class="nc" id="L125">            throw new UserAccessRightException(&quot;You don't have access to this instance&quot;);</span>
        }
<span class="fc" id="L127">        List&lt;DatabaseRef&gt; databaseRefs = Lists.newArrayList();</span>
<span class="fc" id="L128">        databaseRefs.add(databaseRef);</span>

<span class="fc" id="L130">        List&lt;DbDumperServiceInstance&gt; serviceInstances = databaseRef.getDbDumperServiceInstances();</span>
<span class="fc" id="L131">        databaseRef.setDbDumperServiceInstances(this.filteringDbDumperServiceInstance(serviceInstances));</span>

<span class="fc" id="L133">        model.addAttribute(&quot;databaseRefs&quot;, databaseRefs);</span>
<span class="fc" id="L134">        model.addAttribute(&quot;urlForge&quot;, urlForge);</span>
<span class="fc" id="L135">        model.addAttribute(&quot;currency&quot;, currency);</span>
<span class="fc" id="L136">        model.addAttribute(&quot;isFree&quot;, isFree);</span>
<span class="fc" id="L137">        this.addDefaultAttribute(model);</span>
<span class="fc" id="L138">        return &quot;listfiles&quot;;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.eclemma.org/jacoco">JaCoCo</a> 0.7.5.201505241946</span></div></body></html>