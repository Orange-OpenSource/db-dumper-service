#!/usr/bin/env bash
WD=`pwd`
echo "Restoring all binaries..."
echo ""

mysql_version="5.7.10"
mysql_global_version="5.7"
mongodb_version="3.0.8"
postgresql_version="9.4.5"

#####################################################################################
#mysql
#####################################################################################
fileurl="http://dev.mysql.com/get/Downloads/MySQL-${mysql_global_version}/mysql-${mysql_version}-linux-glibc2.5-x86_64.tar.gz"
filepath="mysql-${mysql_version}-linux-glibc2.5-x86_64.tar.gz"
finalfile="mysql-${mysql_version}-linux-glibc2.5-x86_64"
echo "Installing mysql dump and restore binaries..."
if hash curl 2>/dev/null; then
    RESPONSE=$(curl --write-out %{http_code} -L -o "${filepath}" "$fileurl")
else
    wget -o "${filepath}" "$fileurl"
    RESPONSE=$?
fi
if [ "$RESPONSE" != "200" ] && [ "$RESPONSE" != "0" ]; then
    echo "File ${fileurl} not found, so it can't be downloaded."
    rm "$filepath"
    exit 1
fi
mkdir -p "${WD}/src/main/resources/binaries/mysql/bin"
tar -zxvf "$filepath"
cp "$finalfile/bin/mysql" "${WD}/src/main/resources/binaries/mysql/bin"
cp "$finalfile/bin/mysqldump" "${WD}/src/main/resources/binaries/mysql/bin"
rm -Rf "$finalfile"
rm "$filepath"
echo "Done installing mysql binaries."

#####################################################################################
#mongodb
#####################################################################################
fileurl="https://fastdl.mongodb.org/linux/mongodb-linux-x86_64-${mongodb_version}.tgz"
filepath="mongodb-linux-x86_64-${mongodb_version}.tgz"
finalfile="mongodb-linux-x86_64-${mongodb_version}"
echo "Installing mongodb dump and restore binaries..."
if hash curl 2>/dev/null; then
    RESPONSE=$(curl --write-out %{http_code} -L -o "${filepath}" "$fileurl")
else
    wget -o "${filepath}" "$fileurl"
    RESPONSE=$?
fi
if [ "$RESPONSE" != "200" ] && [ "$RESPONSE" != "0" ]; then
    echo "File ${fileurl} not found, so it can't be downloaded."
    rm "$filepath"
    exit 1
fi
mkdir -p "${WD}/src/main/resources/binaries/mongodb/bin"
tar -zxvf "$filepath"
cp "$finalfile/bin/mongodump" "${WD}/src/main/resources/binaries/mongodb/bin"
cp "$finalfile/bin/mongorestore" "${WD}/src/main/resources/binaries/mongodb/bin"
rm -Rf "$finalfile"
rm "$filepath"
echo "Done installing mongodb binaries."

#####################################################################################
#postgresql
#####################################################################################
ARCHNUM=`getconf LONG_BIT`
if [[ "$ARCHNUM" != "64" ]]; then
    echo "you must be on linux 64"
    exit 1
fi
fileurl="https://ftp.postgresql.org/pub/source/v${postgresql_version}/postgresql-${postgresql_version}.tar.gz"
filepath="postgresql-${postgresql_version}.tar.gz"
finalfile="postgresql-${postgresql_version}"
echo "Installing postgresql dump and restore binaries..."
if hash curl 2>/dev/null; then
    RESPONSE=$(curl --write-out %{http_code} -L -o "${filepath}" "$fileurl")
else
    wget -o "${filepath}" "$fileurl"
    RESPONSE=$?
fi
if [ "$RESPONSE" != "200" ] && [ "$RESPONSE" != "0" ]; then
    echo "File ${fileurl} not found, so it can't be downloaded."
    rm "$filepath"
    exit 1
fi
mkdir -p "${WD}/src/main/resources/binaries/postgresql/bin"
mkdir -p "${WD}/src/main/resources/binaries/postgresql/lib"
tar -zxvf "$filepath"
cd "$finalfile"
./configure --without-readline
make
sudo make install
cd -
cd /usr/local/pgsql
sudo cp -Rf "lib/" "${WD}/src/main/resources/binaries/postgresql"
sudo cp "bin/pg_dump" "${WD}/src/main/resources/binaries/postgresql/bin"
sudo cp "bin/pg_restore" "${WD}/src/main/resources/binaries/postgresql/bin"
sudo cp "bin/psql" "${WD}/src/main/resources/binaries/postgresql/bin"
sudo cp "bin/pg_dumpall" "${WD}/src/main/resources/binaries/postgresql/bin"
rm -Rf "$finalfile"
rm "$filepath"
cd -
echo "Done installing postgresql binaries."
echo ""
echo "Binaries are installed."